# 跨平台好友对战大厅技术实现档案

## 项目愿景与目标
- **目标平台**：Windows 与 macOS 双端，可复用相同的 Python 代码基线。
- **核心功能**：好友/房间对战大厅、即时语音与文本聊天、游戏内实时同步、战绩与社交关系管理。
- **可拓展性**：大厅以插件化方式加载不同游戏模块，示例填充包含 2D 射击、狼人杀、大富翁、五子棋与赛车竞速。
- **稳定性**：采用服务器权威（authoritative server）+ 客户端预测（client prediction）以平衡实时性与作弊防护。

## 技术栈与基础设施
- **语言与运行时**：Python 3.11，依赖 `asyncio`、`websockets`、`pydantic`、`uvloop`（可选，提升事件循环性能）。
- **UI 框架**：`PySide6`（Qt for Python）实现跨平台桌面界面，支持自定义窗口、动画与多媒体控件。
- **渲染与游戏引擎**：
  - 2D 模块采用 `arcade`（基于 pyglet），便于快速绘制与碰撞检测。
  - 赛车等 3D/半 3D 模块可使用 `panda3d`（开源、Python 原生）或 `godot-python`（若已有 Godot 资产）。
  - 引擎通过统一的 **GamePlugin API** 适配至大厅壳层，确保资源加载、输入、网络事件回调一致。
- **网络传输**：WebSocket（文本 JSON + 二进制补帧），TLS 终端安全；可选 gRPC for 数据面服务（匹配、存档、支付）。
- **打包发布**：`PyInstaller` 生成 Windows `.exe` 与 macOS `.app`，资源目录通过 `--add-data` 打包，使用 `venv`/`poetry` 锁定依赖。
- **CI/CD**：GitHub Actions/ GitLab CI，矩阵构建（Win + macOS），集成 `pytest`、`mypy`、`ruff`、`playwright`（UI 冒烟）与 `bandit` 安全扫描。

## 客户端架构
```
client/
├─ launcher/            # 登录、更新、补丁与资源校验
├─ shell/               # 大厅 UI、好友/房间/聊天、通知中心
├─ net/                 # WebSocket 管理、重连、心跳、可靠消息封装
├─ plugins/             # GamePlugin 接口与已安装游戏
│  ├─ base.py           # 抽象类：生命周期、场景管理、输入/网络回调
│  ├─ shooter2d/        # 2D 射击游戏模块
│  ├─ werewolf/         # 狼人杀
│  ├─ monopoly/         # 大富翁
│  ├─ gomoku/           # 五子棋
│  └─ racing/           # 赛车竞速
├─ assets/              # 纹理、音效、UI 资源
└─ services/            # 本地缓存、配置、日志、更新策略
```

### GamePlugin API（示例）
- `load(context)`：加载资源、注册输入映射、初始化场景。
- `join_room(room_state)`：根据服务器房间信息进入对局。
- `on_network(event)`：处理来自服务器的帧同步/状态更新。
- `update(dt)`：客户端帧循环；可做客户端预测与插值。
- `render(surface)`：由宿主传入渲染 surface/窗口句柄。
- `dispose()`：释放纹理/音频，回收线程/协程。

### 大厅与社交
- 登录后拉取好友列表、在线状态与推荐房间。
- 房间模式：**匹配房**（快速配对）与 **好友房**（邀请制）。
- 聊天：大厅频道 + 房间频道 + 游戏内队伍频道；文本与可选语音（接入 `webrtc`/`aiortc`）。
- 通知与成就：统一通知中心，支持战绩、排行榜、活动推送。

## 服务器交互与同步模型
- **连接**：客户端通过 WebSocket 连接大厅网关，鉴权使用 `JWT + HMAC`，心跳包含客户端版本与资源包 Hash。
- **房间与匹配**：
  - 匹配服务生成 `match_id`，再由房间服务下发初始状态与种子。
  - 房间采用 **服务器权威**：所有状态更新先在服务器计算，再广播帧号与状态差值。
- **同步策略**：
  - **帧同步**（arcade/Panda3D 可用）：客户端按固定帧率发送输入，服务器计算下一帧并广播。客户端预测本地输入并在收到权威帧时纠正（reconciliation）。
  - **状态同步**（狼人杀/大富翁）：事件驱动，服务器下发状态机转移与计时器，客户端只渲染 UI。
- **延迟与丢包**：
  - 消息格式包含 `frame_id`/`event_id` 与 `timestamp`；客户端维护滑动窗口重传（用于关键指令）。
  - 使用插值/外推平滑移动；对 3D 赛车提供简化物理代理，降低带宽。

## 数据模型（示例）
- 用户：`user_id`、昵称、头像、段位、信用分、好友列表。
- 房间：`room_id`、游戏类型、人数上限、房主/队长、帧率/规则、观战标志。
- 游戏事件：`type`（输入/状态/聊天/系统）、`payload`（JSON Schema 验证）、`frame_id`。
- 资源版本：`asset_pack` 与 `hash`，用于热更新与一致性校验。

## 游戏模块要点
### 1) 2D 射击
- 视角：双摇杆/键鼠，支持局域场景障碍与道具刷新。
- 核心：玩家输入→服务器物理→广播帧，同步子弹与碰撞；客户端预测自我移动，子弹命中由服务器判定。

### 2) 狼人杀
- 房间阶段：发牌、发言/投票、结算；全部走状态同步与计时器，防刷屏与脚本通过服务器节流。
- 语音：可选 `aiortc` 或接入第三方语音 SDK。

### 3) 大富翁
- 规则脚本化：使用 `pydantic` + `state machine` 定义卡牌/地块/骰子事件。
- 作弊防护：关键随机数在服务器生成并签名；客户端展示动画。

### 4) 五子棋
- 极低带宽，直接事件同步；支持复盘记录与观战；落子合法性在服务器校验。

### 5) 赛车竞速
- 使用 Panda3D/物理引擎（Bullet）在服务器做权威物理；客户端做预测与插值。
- 赛道数据通过 `glTF`/自定义二进制资源包加载，客户端缓存并校验哈希。

## 社交与运营功能
- 好友/黑名单、最近组队；邀请与通知通过推送通道实现（WebSocket 子协议）。
- 赛季与段位：匹配分数（Elo 或 TrueSkill）；赛季奖励结算服务。
- 经济系统：虚拟货币、商城皮肤、房卡/门票；支付走后台服务，不在客户端直连第三方。

## 安全与风控
- 资源与代码完整性校验（包签名 + Hash 白名单）。
- 敏感通信开启 TLS 与 WSS；登录、交易接口走签名与滑动窗口防重放。
- 反作弊：
  - 客户端：防调试（反注入）、行为监测、输入频率限制。
  - 服务器：权威判定、异常移动检测、投票/聊天频控、统一日志审计。

## 本地存储与更新
- 本地配置与缓存使用 `sqlite`/`json`；用户数据（token、最近房间）加密存储。
- 启动器检查补丁（差分包），对 `assets` 目录按版本号热更新。

## 架构演进路线
1. **MVP**：实现大厅登录、好友与聊天、五子棋 + 2D 射击最简对局；完成帧同步与重连。
2. **Beta**：扩展狼人杀与大富翁，接入基础语音；上线匹配 Elo；完善反作弊与日志。
3. **正式版**：赛车模块、活动/赛季、皮肤商城、观战与回放、自动化测试矩阵与持续交付。

## 开发与测试建议
- 代码组织：核心组件（net/ui/plugins）分层；插件目录独立资源与配置；统一日志格式（structured logging）。
- 测试策略：
  - 单元测试覆盖网络消息解析、状态机、规则脚本。
  - 集成测试模拟多客户端帧同步；使用 `pytest-asyncio`、`pytest-xdist` 提升并发度。
  - 端到端：playwright/QtBot 驱动 UI；录制对战回放确保回放与权威帧一致。
- 性能监控：客户端 FPS/延迟 HUD；服务器 Prometheus + Grafana；压测使用 `locust`/自研机器人。

## 项目介绍（一页式）
- **名称**：Aether Party（示例）
- **卖点**：多游戏合集、实时社交、跨平台桌面端，一键邀请好友开黑。
- **体验**：
  - 大厅：快速匹配、好友房、聊天与通知，动态活动 banner。
  - 游戏：从轻量的五子棋到紧张的 2D 射击，再到策略向的大富翁与狼人杀，满足不同时长与强度需求；赛车模块提供竞技爽感。
- **技术背书**：Python + Qt + Arcade/Panda3D，服务器权威帧同步，完善的安全与监控体系。
- **商业化**：赛季通行证、装扮/皮肤、活动票券；数据与交易均由后台服务托管，客户端只展示。
